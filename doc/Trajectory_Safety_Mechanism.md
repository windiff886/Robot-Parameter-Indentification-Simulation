# 轨迹安全检查机制说明

## 1. 概述

为了防止在参数辨识过程中，随即生成的激励轨迹导致机械臂发生自碰撞（超出关节限位）或与环境碰撞（触碰地面），我们在力矩控制器节点（`ForceControllerNode`）中引入了轨迹安全检查机制。

## 2. 检查原理

在生成每一组 Fourier 级数轨迹后，系统会在正式执行前调用 `check_trajectory` 函数进行全面的安全性验证。

### 2.1 检查流程

检查函数会以 **0.1秒** 为步长，遍历整个轨迹周期（默认10秒），对每个时间点的状态进行如下两项检查：

#### A. 关节限位检查 (Joint Limits Check)

检查每一个关节的角度位置 $q_i$ 是否在允许的范围内：
$$ q_{min, i} \leq q_i(t) \leq q_{max, i} $$

- **依据**：`robot_model_->jointLimits()` 中定义的物理限位。
- **作用**：防止机械臂运动超出自身的机械结构限制。

#### B. 地面碰撞检查 (Ground Collision Check)

检查机械臂的**所有连杆**（Links）是否与地面发生碰撞。

- **方法**：
    1. 使用正运动学（Forward Kinematics）计算每一个连杆坐标系原点在该时刻的空间位置。
    2. 获取每个坐标系的 Z 轴高度坐标 $z_{link}$。
- **判据**：
    $$ z_{link} \geq \text{SAFETY\_PLANE\_Z} $$
    其中 `SAFETY_PLANE_Z` 设定为 **0.15m (15cm)**。
- **作用**：确保机械臂的任何部位（包括底座、肘部、末端执行器等）在运动过程中始终保持在地面以上 15cm 的安全高度，避免刮擦或撞击地面。

#### C. 夹爪尖端检查 (Gripper Tip Check)

由于地面碰撞检查主要基于连杆坐标系原点，对于安装在末端执行器上的夹爪（Gripper），我们需要额外计算其尖端位置进行检查。

- **方法**：
    1. 获取末端执行器（End Effector）的位姿 $T_{ee}$。
    2. 沿末端局部坐标系的 Z 轴方向平移 `GRIPPER_LENGTH` (20cm) 得到夹爪尖端位置：
       $$ P_{tip} = P_{ee} + R_{ee} \cdot [0, 0, \text{GRIPPER\_LENGTH}]^T $$
    3. 检查 $P_{tip}$ 的 Z 坐标。
- **判据**：
    $$ P_{tip}.z \geq \text{SAFETY\_PLANE\_Z} $$
    其中 `SAFETY_PLANE_Z` 设定为 **0.15m**。
- **作用**：防止在末端朝下运动时，夹爪尖端触碰地面。

## 3. 重试机制 (Retry Logic)

为了保证能够生成有效的安全轨迹，`init_excitation_trajectory` 函数采用以下策略：

1. **随机生成**：使用随机系数生成一组 Fourier 激励轨迹。
2. **安全验证**：调用上述 `check_trajectory` 函数。
3. **自动重试**：
    - 如果验证通过，则采用该轨迹。
    - 如果验证失败，则丢弃该轨迹并重新生成。
    - **最大尝试次数**：默认为 **50次**。
4. **参数调整**：
    - 初始随机幅度（Amplitude）为 **0.2**。
    - 如果连续 **20次** 尝试均未找到安全轨迹，系统会自动将随机幅度缩小为原来的 **0.9倍**，以降低轨迹的剧烈程度，提高通过率。
5. **兜底策略**：
    - 如果 50 次尝试后仍未找到安全轨迹，系统会输出警告，但不得不使用最后一次生成的轨迹（注意：这可能是不安全的，操作人员应立即停止）。*注：通常情况下，50次尝试足以找到安全轨迹。*

## 4. 相关代码

- **源文件**: `src/force_node/src/force_controller_node.cpp`
- **头文件**: `src/force_node/include/force_node/force_controller_node.hpp`
