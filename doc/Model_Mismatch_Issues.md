# 辨识模型与仿真模型不匹配问题分析

本文档详细描述了当前辨识系统中存在的两个主要模型不匹配问题，这些问题会导致辨识结果与真实参数存在系统性偏差。

---

## 问题 1：Armature 未建模

### 1.1 问题描述

在 MuJoCo 模型文件 `panda.xml` 中，每个关节都定义了 `armature` 参数：

```xml
<joint armature="0.1" damping="1" axis="0 0 1" range="-2.8973 2.8973"/>
```

辨识模块中的回归矩阵（Regressor Matrix）没有考虑 armature 效应，导致辨识出的惯量参数会与真实值存在偏差。

> **注意**：`damping` 参数会被辨识模型中的粘滞摩擦项 $F_v$ 自动吸收，因此不会导致力矩预测误差。

---

### 1.2 Armature（电机转子惯量）

#### 物理含义
`armature` 表示电机转子的等效转动惯量（单位：kg·m²）。真实电机的转子在旋转时会产生惯性效应，需要额外的力矩来加速或减速。

#### 对动力学方程的影响
标准的机器人动力学方程为：

$$\tau = M(q) \ddot{q} + C(q, \dot{q}) \dot{q} + g(q)$$

MuJoCo 会在惯量矩阵的对角线上添加 armature 项：

$$\tau = \left[ M(q) + \text{diag}(I_{a1}, I_{a2}, ..., I_{an}) \right] \ddot{q} + C(q, \dot{q}) \dot{q} + g(q)$$

其中 $I_{ai}$ 是第 $i$ 个关节的 armature 值（本例中均为 0.1）。

#### 对辨识的影响
由于辨识模型没有包含 armature 项，这些额外的惯量会被**错误地分配**到其他与加速度相关的参数中，例如：
- 连杆惯量矩阵的对角元素（$I_{xx}$, $I_{yy}$, $I_{zz}$）
- 质量相关参数

---

### 1.3 解决方案

**方案 A：修改 MuJoCo 模型**
将 `armature` 设为 0，使仿真模型与辨识模型假设一致：
```xml
<joint armature="0" damping="1" axis="0 0 1" range="-2.8973 2.8973"/>
```

**方案 B：修改回归矩阵**
在回归矩阵中显式添加 armature 效应的对应列：
- Armature 列：$Y_{armature}[:, i] = \ddot{q}_i$（与关节加速度成正比）

---

## 问题 2：夹爪质量未建模

### 2.1 问题描述

MuJoCo 仿真使用的模型 `panda.xml` 包含完整的 Franka Panda 机械臂结构，其中在 Link 7 末端安装了夹爪（Hand）：

```xml
<body name="hand" pos="0 0 0.107" quat="0.9238795 0 0 -0.3826834">
  <inertial mass="0.73" pos="-0.01 0 0.03" diaginertia="0.001 0.0025 0.0017"/>
  <!-- 两个手指 -->
  <body name="left_finger">
    <inertial mass="0.015" .../>
  </body>
  <body name="right_finger">
    <inertial mass="0.015" .../>
  </body>
</body>
```

但是，辨识模块中的机器人模型（`franka_panda.cpp`）只定义了 Link 0 ~ Link 7 共 8 个连杆的惯性参数，**没有包含夹爪和手指的质量**。

### 2.2 未建模的质量

| 部件             | 质量 (kg) | 位置（相对于 Link 7） |
| ---------------- | --------- | --------------------- |
| Hand（夹爪本体） | 0.73      | z = 0.107 m           |
| Left Finger      | 0.015     | z = 0.107 + 0.0584 m  |
| Right Finger     | 0.015     | z = 0.107 + 0.0584 m  |
| **合计**         | **0.76**  | -                     |

### 2.3 对动力学的影响

#### 重力项 $g(q)$ 偏差
夹爪质量会产生额外的重力矩。由于夹爪位于机械臂末端（杠杆臂最大），其影响尤为显著：
- 对于关节 1~7，都会有额外的重力力矩
- 误差随关节距离基座越近而放大（力臂效应）

#### 惯量矩阵 $M(q)$ 偏差
夹爪的转动惯量会使末端关节（Joint 5, 6, 7）的等效惯量偏大。

#### 科里奥利/向心力矩 $C(q, \dot{q})$ 偏差
夹爪质心在运动时会产生额外的向心力和科里奥利力。

### 2.4 解决方案

**方案 A：在辨识模型中添加夹爪**
在 `franka_panda.cpp` 中添加 Link 8（Hand）作为固定负载，并更新回归矩阵的计算。

**方案 B：将夹爪视为 Link 7 的附加质量**
将夹爪的质量和惯量合并到 Link 7 的参数中。

**方案 C：使用无夹爪的仿真模型**
使用 `panda_nohand.xml` 进行仿真，该模型不包含夹爪。

---

## 总结

| 问题            | 影响的参数       | 误差类型   | 推荐解决方案          |
| --------------- | ---------------- | ---------- | --------------------- |
| Armature 未建模 | 惯量矩阵对角元素 | 惯量偏大   | 设置 armature=0       |
| 夹爪未建模      | 重力项、惯量矩阵 | 系统性偏差 | 使用 panda_nohand.xml |

为了获得最准确的辨识结果，建议同时实施以上两个修改。
