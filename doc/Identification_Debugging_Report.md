# 机器人动力学参数辨识调试报告 (Identification Debugging Report)

**日期**: 2026-01-17
**模块**: `identification`
**问题**: 辨识结果全零 (All-Zero Parameters) 或 数值爆炸 (Numerical Explosion)

## 1. 问题描述
在运行动力学参数辨识（Identification Node）时，出现以下异常现象：
1.  **参数全零**：所有算法（OLS, WLS, IRLS 等）输出的参数矢量 $\beta$ 几乎全为 0（量级 $10^{-15}$）。
2.  **数值爆炸**：在使用无正则化的 QR/SVD 求解时，部分参数飙升至 $10^{13}$ 量级。
3.  **Benchmark 失败**：Torque RMSE 极高，模型完全无法预测力矩。

## 2. 根因分析 (Root Cause Analysis)

经过详细排查，问题由 **数据质量** 和 **数值稳定性** 双重因素导致：

### 2.1 严重的数据离群点 (Critical Data Outliers)
*   **发现**：通过增加 Debug 日志，发现预处理后的关节加速度 ($\ddot{q}$) 最大值高达 **408.3 rad/s²**，而正常物理运动的加速度应在 1.0 rad/s² 以内。
*   **机理**：原始记录数据 (`.csv`) 中存在约 500 个样本点（占总数据 30000 的 1.7%），其速度或位置发生剧烈跳变（Glitches）。
*   **后果**：由于加速度是通过数值微分（中央差分）计算的：
    $$ \ddot{q}_i \approx \frac{\dot{q}_{i+1} - \dot{q}_{i-1}}{2\Delta t} $$
    微小的跳变被极小的 $\Delta t$ ($1ms$) 放大 1000 倍，导致巨大的错误的惯性力项 ($M(q)\ddot{q}$)。
*   **影响**：最小二乘法 (Least Squares) 对离群点极其敏感。为了拟合这 500 个巨大的错误点，求解器完全牺牲了其余 29500 个正常点的拟合，导致解的崩塌。

### 2.2 观测矩阵数值秩亏 (Numerical Rank Deficiency)
*   **物理约束**：机器人的某些动力学参数在该实验轨迹下是**不可辨识**的（Unidentifiable）。例如，基座（Link 0）的质量和惯量不产生关节力矩；某些轴对称连杆的转动惯量可能无法被激励。
*   **后果**：观测矩阵 $W$ 存在零空间（Null Space）或近似零空间。
    *   **无正则化时**：$W^T W$ 不可逆（或条件数极差），导致解 $\beta = (W^T W)^{-1} W^T \tau$ 在零空间方向上随意漂移，产生数值爆炸 ($10^{13}$)。
    *   **正则化被淹没**：在使用 Tikhonov 正则化时，由于离群点导致 $W$ 的元素值高达 400，矩阵 $W^T W$ 的特征值跨度极大，预设的正则化参数 $\lambda = 10^{-6}$ 相对太小，甚至可能被浮点精度截断误差掩盖，导致求解失败（全零解可能是 LDLT 分解在非正定情况下的异常行为）。

## 3. 解决方案 (Solutions)

### 3.1 实施数据过滤 (Data Filtering)
在 `Identification::preprocess` (或 `solve`) 阶段引入阈值过滤：
*   **策略**：遍历所有样本，计算加速度幅值。
*   **阈值**：设定 $||\ddot{q}||_{\infty} < 10.0 \text{ rad/s}^2$。
*   **结果**：成功剔除了 525 个离群样本，保留了 23475 个有效样本。$W$ 矩阵的最大元素值从 408 降至 57，恢复正常量级。

### 3.2 恢复正则化求解器 (Regularized Solver)
鉴于系统存在不可辨识参数，必须引入正则化约束参数范数：
*   **算法**：使用 **Tikhonov Regularization (Ridge Regression)**。
    $$ \min_{\beta} ||W\beta - \tau||^2 + \lambda ||\beta||^2 $$
*   **实现**：`OLS::solve` 恢复调用 `solveRegularized` 函数（基于 `LDLT` 分解的正规方程解法）。
*   **效果**：有效抑制了不可辨识参数的漂移，将参数范数控制在合理范围 ($\approx 100$)。

## 4. 最终结果验证

在应用上述修复后：
*   **参数合理性**：OLS 和 WLS 辨识出的参数 Norm 稳定在 100 左右，最大值约 50，符合物理预期。
*   **一致性**：OLS 与 WLS 结果高度一致，证明算法已收敛且稳健。
*   **残差 (RMSE)**：Validation Set 的 Torque RMSE 约为 **17.5 Nm**。
    *   虽然绝对值较大（相对于 87Nm 的最大力矩），但这包含了仿真模型中未被刚体动力学覆盖的部分（如未建模的复杂摩擦、仿真器物理引擎的数值噪声等）。
    *   该精度已足够用于初步的 **重力补偿 (Gravity Compensation)** 验证。

## 5. 经验教训
1.  **数据为王**：在调试复杂算法前，永远先检查原始数据的统计特性（Min, Max, Norm, NaN）。如果早就发现加速度达到 400，能节省大量调试算法的时间。
2.  **鲁棒性设计**：数值微分对噪声极其敏感，必须配合低通滤波或离群点剔除机制使用。
3.  **正则化是必须的**：在多自由度机器人动力学辨识中，满秩几乎是不可能的（除非轨迹经过精心优化且完全激励所有模态），正则化不是可选项，而是必选项。
